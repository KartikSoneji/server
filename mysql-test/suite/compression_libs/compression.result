# Testing all compression libraries


#
# Test --use-compression=lz4 on storage engine "innodb"
#
# Start server with default options (lz4 enabled)
# restart: --use-compression=lz4
DROP TABLE IF EXISTS lz4;
SET GLOBAL Innodb_compression_algorithm = lz4;
CREATE TABLE lz4 (
a int,
b text 
)
engine = innodb
page_compressed = 1
;
INSERT INTO lz4 (a, b) VALUES (0, "abc");
INSERT INTO lz4 (a, b) VALUES (1, "def");
INSERT INTO lz4 (a, b) VALUES (2, "ghi");
SELECT * FROM lz4;
a	b
0	abc
1	def
2	ghi
# Start server with no libraries
# restart: --use_compression=
# Table should not exist, as server does not know how to read compressed data
SELECT * FROM lz4;
ERROR 42S02: Table 'test.lz4' doesn't exist in engine
DROP TABLE lz4;
UNINSTALL SONAME IF EXISTS "ha_connect.so";
UNINSTALL SONAME IF EXISTS "ha_mroonga.so";
UNINSTALL SONAME IF EXISTS "ha_rocksdb.so";
# restart


#
# Test --use-compression=lz4 on storage engine "mroonga"
#
# Start server with default options (lz4 enabled)
# restart: --use-compression=lz4
DROP TABLE IF EXISTS lz4;
INSTALL SONAME "ha_mroonga.so";
CREATE TABLE lz4 (
a int,
b text COMMENT 'FLAGS "COLUMN_SCALAR|COMPRESS_LZ4"'
)
engine = mroonga
charset = utf8
;
INSERT INTO lz4 (a, b) VALUES (0, "abc");
INSERT INTO lz4 (a, b) VALUES (1, "def");
INSERT INTO lz4 (a, b) VALUES (2, "ghi");
INSERT INTO lz4 (a, b) VALUES (3, "
        This is an extra long string to exceed Mroonga's compression threshold of 256 bytes (= 256 characters).
        Mroonga dosen't compress strings that are below the threshold, which
        means if the server is started without a compression library then for records:
            |\       | < threshold | >= threshold      |
            |---------|-------------|-------------------|
            | Reading | Works fine  | Records are blank |
            | Writing | Works fine  | Throws an error   |
        Note that create a compressed table will work even if the library is not loaded.
    ");
SELECT * FROM lz4;
a	b
0	abc
1	def
2	ghi
3	
        This is an extra long string to exceed Mroonga's compression threshold of 256 bytes (= 256 characters).
        Mroonga dosen't compress strings that are below the threshold, which
        means if the server is started without a compression library then for records:
            |       | < threshold | >= threshold      |
            |---------|-------------|-------------------|
            | Reading | Works fine  | Records are blank |
            | Writing | Works fine  | Throws an error   |
        Note that create a compressed table will work even if the library is not loaded.
    
# Start server with no libraries
# restart: --use_compression=
# Inserting a record below the threshold should work
INSERT INTO lz4 (a, b) VALUES (4, "jkl");
# But inserting a record above the threshold should fail
INSERT INTO lz4 (a, b) VALUES (5, "
        0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ
        0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ
        0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ
        0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ
    ");
ERROR HY000: [ja][lz4] failed to compress: <lz4.b>: <6>
# Records below the threshold (abc, def, ghi) should appear, but records above the threshold should not
SELECT * FROM lz4;
a	b
0	abc
1	def
2	ghi
3	
4	jkl
DROP TABLE lz4;
UNINSTALL SONAME IF EXISTS "ha_connect.so";
UNINSTALL SONAME IF EXISTS "ha_mroonga.so";
UNINSTALL SONAME IF EXISTS "ha_rocksdb.so";
# restart
